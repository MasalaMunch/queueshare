"use strict";

const assert = require(`assert`);
const fs = require(`fs`);
const Path = require(`path`);

const encoding = `utf8`;

const separator = `\n`;

module.exports = class {

    constructor ({dir}) {

        fs.mkdirSync(dir, {recursive: true});

        this._file = Path.join(dir, `json.log`);

        this._fileAppendStream = 
            fs.createWriteStream(this._file, {encoding, flags: `a`});

    }

    clear () {

        fs.writeFileSync(this._file, ``, {encoding});

    }

    Entries () {

        let fileAsString;

        try {

            fileAsString = fs.readFileSync(this._file, {encoding});

        } 
        catch (error) {

            if (error.code === `ENOENT`) {

                fileAsString = ``;

            }
            else {

                throw error;
                
            }

        }

        const entriesAsStrings = fileAsString.split(separator);

        entriesAsStrings.pop();

        return entriesAsStrings.map(JSON.parse);

    }

    addToWriteQueue (entry) {

        const entryAsString = JSON.stringify(entry);

        assert(typeof entryAsString === `string`);

        this._fileAppendStream.write(entryAsString + separator);

    }

    };